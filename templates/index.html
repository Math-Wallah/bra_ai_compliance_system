{% extends "base.html" %}

{% block title %}Dashboard - BRA AI Compliance System{% endblock %}

{% block content %}
<h2>Dashboard Overview</h2>

<div class="stats-grid">
    <div class="stat-box">
        <h3>Total Taxpayers</h3>
        <div class="value" id="total-taxpayers">-</div>
    </div>
    <div class="stat-box">
        <h3>Returns Filed</h3>
        <div class="value" id="total-returns">-</div>
    </div>
    <div class="stat-box">
        <h3>Audits Completed</h3>
        <div class="value" id="audits-completed">-</div>
    </div>
    <div class="stat-box">
        <h3>Tax Recovery</h3>
        <div class="value" id="tax-recovery">-</div>
    </div>
    <div class="stat-box">
        <h3>Compliance Rate</h3>
        <div class="value" id="compliance-rate">-</div>
    </div>
</div>

<div class="card">
    <h2>ðŸš¨ High-Risk Taxpayers (Top 10)</h2>
    <table>
        <thead>
            <tr>
                <th>Taxpayer ID</th>
                <th>Business Name</th>
                <th>Industry</th>
                <th>Risk Score</th>
                <th>Anomaly Score</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="high-risk-tbody">
            <tr><td colspan="6">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h2>ðŸ“Š System Information</h2>
    <p><strong>System Status:</strong> <span style="color: #4caf50;">âœ“ Operational</span></p>
    <p><strong>Last Updated:</strong> <span id="last-updated">-</span></p>
    <p><strong>Models Trained:</strong> Anomaly Detection âœ“ | Risk Scoring âœ“</p>
    <p><strong>Data Source:</strong> Taxpayer Master Data | Tax Returns | Audit History</p>
</div>

<script>
    async function loadDashboardData() {
        try {
            // Load stats
            const statsRes = await fetch('/api/dashboard-stats');
            const stats = await statsRes.json();
            
            document.getElementById('total-taxpayers').textContent = stats.total_taxpayers;
            document.getElementById('total-returns').textContent = stats.total_returns_filed;
            document.getElementById('audits-completed').textContent = stats.audits_completed;
            document.getElementById('tax-recovery').textContent = 'â‚¨ ' + stats.tax_recovery.toLocaleString('en-PK', {maximumFractionDigits: 0});
            document.getElementById('compliance-rate').textContent = stats.compliance_rate.toFixed(1) + '%';
            
            // Load high-risk taxpayers
            const riskRes = await fetch('/api/high-risk-taxpayers');
            const riskData = await riskRes.json();
            
            const tbody = document.getElementById('high-risk-tbody');
            tbody.innerHTML = '';
            
            riskData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.Taxpayer_ID}</strong></td>
                    <td>${row.Business_Name}</td>
                    <td>${row.Industry_Name}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${row.Risk_Score * 100}%"></div>
                        </div>
                        ${(row.Risk_Score * 100).toFixed(1)}%
                    </td>
                    <td>${(row.Anomaly_Score * 100).toFixed(1)}%</td>
                    <td><a href="/taxpayer/${row.Taxpayer_ID}" class="button">View</a></td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }
    
    // Load data on page load
    loadDashboardData();
    
    // Refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
</script>
{% endblock %}
