{% extends "base.html" %}

{% block title %}Anomaly Detection - BRA AI Compliance System{% endblock %}

{% block content %}
<h2>üîç Anomaly Detection Results</h2>

<div class="card">
    <p>This page shows taxpayers with unusual tax return patterns detected by the Isolation Forest algorithm.</p>
</div>

<div class="card">
    <h2>Detected Anomalies</h2>
    <table>
        <thead>
            <tr>
                <th>Taxpayer ID</th>
                <th>Business Name</th>
                <th>Industry</th>
                <th>Input Tax Ratio</th>
                <th>Revenue Growth</th>
                <th>Anomaly Score</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="anomalies-tbody">
            <tr><td colspan="8">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
    async function loadAnomalies() {
        try {
            const res = await fetch('/api/anomalies');
            const data = await res.json();
            
            const tbody = document.getElementById('anomalies-tbody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                const statusBadge = row.Is_Anomalous ? 
                    '<span class="badge critical">ANOMALOUS</span>' : 
                    '<span class="badge low">NORMAL</span>';
                
                tr.innerHTML = `
                    <td><strong>${row.Taxpayer_ID}</strong></td>
                    <td>${row.Business_Name}</td>
                    <td>${row.Industry_Name}</td>
                    <td>${(row.Input_Tax_Ratio * 100).toFixed(2)}%</td>
                    <td>${(row.Revenue_Growth * 100).toFixed(2)}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${row.Anomaly_Score * 100}%; background-color: ${row.Anomaly_Score > 0.5 ? '#ff4444' : '#4caf50'};"></div>
                        </div>
                        ${(row.Anomaly_Score * 100).toFixed(1)}%
                    </td>
                    <td>${statusBadge}</td>
                    <td><a href="/taxpayer/${row.Taxpayer_ID}" class="button">Investigate</a></td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading anomalies:', error);
        }
    }
    
    loadAnomalies();
</script>
{% endblock %}
