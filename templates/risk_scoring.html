{% extends "base.html" %}

{% block title %}Risk Scoring - BRA AI Compliance System{% endblock %}

{% block content %}
<h2>ðŸ“ˆ Compliance Risk Scoring</h2>

<div class="card">
    <p>Risk scores are calculated using a Gradient Boosting Machine trained on historical audit data. Scores range from 0 (Low Risk) to 1 (High Risk).</p>
</div>

<div class="card">
    <h2>All Taxpayers - Risk Assessment</h2>
    <table>
        <thead>
            <tr>
                <th>Taxpayer ID</th>
                <th>Business Name</th>
                <th>Industry</th>
                <th>Risk Score</th>
                <th>Risk Level</th>
                <th>Anomaly Score</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="risk-scores-tbody">
            <tr><td colspan="7">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
    function getRiskLevelBadge(level) {
        const badges = {
            'CRITICAL': '<span class="badge critical">CRITICAL</span>',
            'HIGH': '<span class="badge high">HIGH</span>',
            'MEDIUM': '<span class="badge medium">MEDIUM</span>',
            'LOW': '<span class="badge low">LOW</span>'
        };
        return badges[level] || '<span class="badge low">UNKNOWN</span>';
    }
    
    async function loadRiskScores() {
        try {
            const res = await fetch('/api/risk-scores');
            const data = await res.json();
            
            const tbody = document.getElementById('risk-scores-tbody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.Taxpayer_ID}</strong></td>
                    <td>${row.Business_Name}</td>
                    <td>${row.Industry_Name}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${row.Risk_Score * 100}%; background-color: ${row.Risk_Score > 0.7 ? '#ff4444' : row.Risk_Score > 0.5 ? '#ff9800' : '#4caf50'};"></div>
                        </div>
                        ${(row.Risk_Score * 100).toFixed(1)}%
                    </td>
                    <td>${getRiskLevelBadge(row.Risk_Level)}</td>
                    <td>${(row.Anomaly_Score * 100).toFixed(1)}%</td>
                    <td><a href="/taxpayer/${row.Taxpayer_ID}" class="button">Review</a></td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading risk scores:', error);
        }
    }
    
    loadRiskScores();
</script>
{% endblock %}
